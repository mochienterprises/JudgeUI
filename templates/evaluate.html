{% extends "base.html" %}

{% block title %}Evaluate Arguments - JudgeUI{% endblock %}

{% block content %}
<div class="px-4" x-data="evaluateApp()">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Evaluate Arguments</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Selection Panel -->
        <div>
            <!-- Tabs -->
            <div class="bg-white rounded-t-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px">
                        <button @click="inputMode = 'existing'" 
                                :class="inputMode === 'existing' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                            Existing Arguments
                        </button>
                        <button @click="inputMode = 'custom'" 
                                :class="inputMode === 'custom' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                                class="w-1/2 py-4 px-1 text-center border-b-2 font-medium text-sm">
                            Custom Text
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Existing Arguments Tab -->
            <div x-show="inputMode === 'existing'" class="bg-white rounded-b-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Select Argument</h2>

                <div class="mb-4">
                    <input type="text" 
                           x-model="searchQuery"
                           placeholder="Search arguments..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="max-h-96 overflow-y-auto border border-gray-200 rounded-md">
                    <template x-for="arg in filteredArguments" :key="arg.id">
                        <div @click="selectArgument(arg.id)" 
                             :class="selectedArgId === arg.id ? 'bg-indigo-50 border-indigo-500' : 'hover:bg-gray-50'"
                             class="p-3 border-b border-gray-200 cursor-pointer">
                            <p class="font-medium text-sm" x-text="arg.topic"></p>
                            <p class="text-xs text-gray-600" x-text="`${arg.stance} · ${arg.source} · ${arg.id}`"></p>
                            <p class="text-xs text-gray-500 mt-1" x-text="arg.preview"></p>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Custom Text Tab -->
            <div x-show="inputMode === 'custom'" class="bg-white rounded-b-lg shadow p-6 mb-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Enter Custom Argument</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Paste or type your argument text:
                    </label>
                    <textarea x-model="customText" 
                              rows="12"
                              placeholder="Enter the argument you want to evaluate..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 text-sm"
                    ></textarea>
                    <p class="text-xs text-gray-500 mt-1" x-text="`${customText.length} characters`"></p>
                </div>
            </div>

            <!-- Judge Configuration -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Judge Configuration</h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                    <select x-model="model" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        {% for model in models %}
                            <option value="{{ model.id }}">{{ model.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Evaluator Prompt</label>
                    <select x-model="prompt" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        {% for prompt in prompts %}
                            <option value="{{ prompt }}">{{ prompt|capitalize }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Temperature: <span x-text="temperature"></span>
                    </label>
                    <input type="range" 
                           x-model="temperature" 
                           min="0" 
                           max="1" 
                           step="0.1"
                           class="w-full">
                </div>

                <button @click="evaluate" 
                        :disabled="loading || (inputMode === 'existing' && !selectedArgId) || (inputMode === 'custom' && !customText.trim())"
                        class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:bg-gray-400">
                    <span x-show="!loading">Evaluate Argument</span>
                    <span x-show="loading">Evaluating...</span>
                </button>
            </div>
        </div>

        <!-- Results Panel -->
        <div>
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Evaluation Results</h2>

                <div x-show="error" class="mb-4 p-3 bg-red-100 text-red-700 rounded-md text-sm" x-cloak>
                    <strong>Error:</strong> <span x-text="error"></span>
                </div>

                <div x-show="result" x-cloak>
                    <!-- Score Display -->
                    <div class="mb-6 text-center">
                        <div class="inline-block">
                            <div class="text-5xl font-bold" 
                                 :class="result.evaluation.score >= 70 ? 'text-green-600' : result.evaluation.score >= 40 ? 'text-yellow-600' : 'text-red-600'"
                                 x-text="result.evaluation.score"></div>
                            <p class="text-sm text-gray-600">Score (0-100)</p>
                        </div>

                        <div x-show="result.argument.expected_score && result.argument.expected_score > 0" class="mt-2">
                            <p class="text-sm text-gray-600">
                                Expected: <span x-text="result.argument.expected_score"></span>
                                <span class="ml-2" 
                                      :class="result.evaluation.score_delta > 0 ? 'text-green-600' : 'text-red-600'"
                                      x-text="'(Δ ' + result.evaluation.score_delta + ')'"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Detected Faults -->
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-900 mb-2">Detected Faults</h3>
                        <div x-show="result.evaluation.detected_faults.length === 0" class="text-sm text-gray-500">
                            No faults detected - this appears to be a well-reasoned argument
                        </div>
                        <div x-show="result.evaluation.detected_faults.length > 0" class="flex flex-wrap gap-2">
                            <template x-for="fault in result.evaluation.detected_faults">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium" x-text="fault"></span>
                            </template>
                        </div>
                    </div>

                    <!-- Ground Truth Comparison (only for generated arguments with faults) -->
                    <div x-show="result.argument.injected_faults && result.argument.injected_faults.length > 0" class="mb-4">
                        <h3 class="font-semibold text-gray-900 mb-2">Ground Truth Analysis</h3>
                        <div class="grid grid-cols-3 gap-2 text-center text-sm">
                            <div class="p-2 bg-green-50 rounded">
                                <p class="text-2xl font-bold text-green-600" x-text="result.evaluation.true_positives.length"></p>
                                <p class="text-xs text-gray-600">True Positives</p>
                            </div>
                            <div class="p-2 bg-yellow-50 rounded">
                                <p class="text-2xl font-bold text-yellow-600" x-text="result.evaluation.false_negatives.length"></p>
                                <p class="text-xs text-gray-600">False Negatives</p>
                            </div>
                            <div class="p-2 bg-red-50 rounded">
                                <p class="text-2xl font-bold text-red-600" x-text="result.evaluation.false_positives.length"></p>
                                <p class="text-xs text-gray-600">False Positives</p>
                            </div>
                        </div>
                        
                        <div class="mt-3 p-3 bg-gray-50 rounded text-xs">
                            <p class="font-medium text-gray-700 mb-1">Injected Faults:</p>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="fault in result.argument.injected_faults">
                                    <span class="px-2 py-1 bg-gray-200 text-gray-700 rounded" x-text="fault"></span>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Reasoning -->
                    <div class="mb-4">
                        <h3 class="font-semibold text-gray-900 mb-2">Judge's Reasoning</h3>
                        <p class="text-sm text-gray-700 bg-gray-50 p-3 rounded" x-text="result.evaluation.reasoning"></p>
                    </div>

                    <!-- Argument Text -->
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-2">Evaluated Argument</h3>
                        <div class="text-sm text-gray-700 bg-gray-50 p-3 rounded max-h-64 overflow-y-auto">
                            <p x-text="result.argument.text"></p>
                        </div>
                    </div>
                </div>

                <div x-show="!result && !loading && !error" class="text-center text-gray-400 py-12">
                    <p>Evaluation results will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function evaluateApp() {
    return {
        inputMode: 'existing',
        arguments: {{ arguments | tojson }},
        searchQuery: '',
        selectedArgId: null,
        customText: '',
        model: 'claude-sonnet-4-5',
        prompt: 'default',
        temperature: 0.0,
        loading: false,
        error: null,
        result: null,

        get filteredArguments() {
            if (!this.searchQuery) return this.arguments;
            const query = this.searchQuery.toLowerCase();
            return this.arguments.filter(arg => 
                arg.topic.toLowerCase().includes(query) ||
                arg.stance.toLowerCase().includes(query) ||
                arg.id.toLowerCase().includes(query)
            );
        },

        selectArgument(id) {
            this.selectedArgId = id;
            this.result = null;
            this.error = null;
        },

        async evaluate() {
            this.loading = true;
            this.error = null;
            this.result = null;

            try {
                const payload = {
                    model: this.model,
                    temperature: parseFloat(this.temperature),
                    prompt: this.prompt
                };

                // Add either argument_id or custom_text
                if (this.inputMode === 'custom') {
                    payload.custom_text = this.customText;
                } else {
                    payload.argument_id = this.selectedArgId;
                }

                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (data.success) {
                    this.result = data;
                } else {
                    this.error = data.error;
                }
            } catch (e) {
                this.error = 'Failed to evaluate argument: ' + e.message;
            } finally {
                this.loading = false;
            }
        }
    }
}
</script>
{% endblock %}
