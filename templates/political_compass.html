{% extends "base.html" %}

{% block title %}Political Compass - JudgeUI{% endblock %}

{% block content %}
<div class="px-4" x-data="politicalCompassApp()">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Political Compass Testing</h1>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Configuration Panel -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6 sticky top-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Test Configuration</h2>

                <!-- Model Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Model</label>
                    <select x-model="selectedModel" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        {% for model in models %}
                            <option value="{{ model.id }}">{{ model.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Bias Condition -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Bias Condition</label>
                    <select x-model="selectedBias" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                        {% for bias in biases %}
                            <option value="{{ bias.id }}">{{ bias.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500 mt-1">
                        Baseline tests natural position. Others test bias manipulation.
                    </p>
                </div>

                <!-- Run Button -->
                <button @click="runTest" 
                        :disabled="loading"
                        class="w-full bg-indigo-600 text-white py-3 px-4 rounded-md hover:bg-indigo-700 disabled:bg-gray-400 font-medium">
                    <span x-show="!loading">Run Test (62 Questions)</span>
                    <span x-show="loading">Testing... <span x-text="progress"></span>/62</span>
                </button>

                <!-- Info -->
                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <p class="text-sm text-blue-800">
                        <strong>Note:</strong> This takes 2-3 minutes and costs ~$0.50 in API calls.
                    </p>
                </div>

                <!-- Previous Results -->
                <div x-show="history.length > 0" class="mt-6">
                    <h3 class="font-semibold text-gray-900 mb-2">Previous Tests</h3>
                    <div class="space-y-2">
                        <template x-for="(test, index) in history" :key="index">
                            <button @click="showResult(test)" 
                                    class="w-full text-left p-2 bg-gray-50 hover:bg-gray-100 rounded text-sm">
                                <p class="font-medium" x-text="test.model"></p>
                                <p class="text-xs text-gray-600" x-text="`${test.bias} - E:${test.result.economic} S:${test.result.social}`"></p>
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Results</h2>

                <div x-show="error" class="mb-4 p-4 bg-red-100 text-red-700 rounded-md" x-cloak>
                    <strong>Error:</strong> <span x-text="error"></span>
                </div>

                <div x-show="!result && !loading && !error" class="text-center text-gray-400 py-12">
                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <p>Run a test to see results</p>
                </div>

                <div x-show="result" x-cloak>
                    <!-- Compass Visualization -->
                    <div class="mb-6">
                        <div class="relative w-full" style="padding-bottom: 100%;">
                            <svg class="absolute inset-0 w-full h-full" viewBox="-11 -11 22 22">
                                <!-- Background quadrants -->
                                <rect x="-10" y="-10" width="10" height="10" fill="#fef3c7" opacity="0.3"/>
                                <rect x="0" y="-10" width="10" height="10" fill="#dbeafe" opacity="0.3"/>
                                <rect x="-10" y="0" width="10" height="10" fill="#fecaca" opacity="0.3"/>
                                <rect x="0" y="0" width="10" height="10" fill="#bbf7d0" opacity="0.3"/>
                                
                                <!-- Grid lines -->
                                <line x1="-10" y1="0" x2="10" y2="0" stroke="#9ca3af" stroke-width="0.1"/>
                                <line x1="0" y1="-10" x2="0" y2="10" stroke="#9ca3af" stroke-width="0.1"/>
                                
                                <!-- Minor grid -->
                                <template x-for="i in 9">
                                    <line :x1="-10 + (i * 2.22)" y1="-10" :x2="-10 + (i * 2.22)" y2="10" stroke="#e5e7eb" stroke-width="0.05"/>
                                </template>
                                <template x-for="i in 9">
                                    <line x1="-10" :y1="-10 + (i * 2.22)" x2="10" :y2="-10 + (i * 2.22)" stroke="#e5e7eb" stroke-width="0.05"/>
                                </template>
                                
                                <!-- Axes labels -->
                                <text x="-10" y="-10.5" font-size="0.8" fill="#6b7280" text-anchor="start">Auth Left</text>
                                <text x="10" y="-10.5" font-size="0.8" fill="#6b7280" text-anchor="end">Auth Right</text>
                                <text x="-10" y="10.8" font-size="0.8" fill="#6b7280" text-anchor="start">Lib Left</text>
                                <text x="10" y="10.8" font-size="0.8" fill="#6b7280" text-anchor="end">Lib Right</text>
                                
                                <!-- Result point -->
                                <circle 
                                    :cx="result.economic" 
                                    :cy="result.social" 
                                    r="0.5" 
                                    fill="#4f46e5" 
                                    stroke="#312e81" 
                                    stroke-width="0.1"
                                />
                                
                                <!-- Crosshairs -->
                                <line 
                                    :x1="result.economic - 1" 
                                    :y1="result.social" 
                                    :x2="result.economic + 1" 
                                    :y2="result.social" 
                                    stroke="#4f46e5" 
                                    stroke-width="0.1"
                                />
                                <line 
                                    :x1="result.economic" 
                                    :y1="result.social - 1" 
                                    :x2="result.economic" 
                                    :y2="result.social + 1" 
                                    stroke="#4f46e5" 
                                    stroke-width="0.1"
                                />
                            </svg>
                        </div>
                    </div>

                    <!-- Scores -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold" 
                               :class="result.economic < 0 ? 'text-red-600' : 'text-blue-600'"
                               x-text="result.economic"></p>
                            <p class="text-sm text-gray-600">Economic</p>
                            <p class="text-xs text-gray-500" x-text="result.economic < 0 ? 'Left' : 'Right'"></p>
                        </div>
                        <div class="text-center p-4 bg-gray-50 rounded-lg">
                            <p class="text-3xl font-bold" 
                               :class="result.social < 0 ? 'text-green-600' : 'text-yellow-600'"
                               x-text="result.social"></p>
                            <p class="text-sm text-gray-600">Social</p>
                            <p class="text-xs text-gray-500" x-text="result.social < 0 ? 'Libertarian' : 'Authoritarian'"></p>
                        </div>
                    </div>

                    <!-- Interpretation -->
                    <div class="p-4 bg-indigo-50 rounded-lg mb-4">
                        <p class="text-sm text-indigo-900">
                            <strong>Position:</strong> 
                            <span x-text="getQuadrant(result.economic, result.social)"></span>
                        </p>
                    </div>

                    <!-- Response Details (collapsible) -->
                    <details class="mt-4">
                        <summary class="cursor-pointer font-medium text-gray-900 hover:text-indigo-600">
                            View All 62 Responses
                        </summary>
                        <div class="mt-4 space-y-2 max-h-96 overflow-y-auto">
                            <template x-for="response in result.responses" :key="response.question_id">
                                <div class="text-sm p-2 bg-gray-50 rounded">
                                    <p class="font-medium text-gray-700" x-text="`Q${response.question_id}: ${response.text}`"></p>
                                    <p class="text-gray-600 mt-1">
                                        <span class="font-medium" x-text="response.answer.replace('_', ' ')"></span>
                                        <span class="text-xs text-gray-500 ml-2" x-text="`(${response.axis} - ${response.direction})`"></span>
                                    </p>
                                </div>
                            </template>
                        </div>
                    </details>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function politicalCompassApp() {
    return {
        selectedModel: 'claude-sonnet-4-5',
        selectedBias: 'baseline',
        loading: false,
        progress: 0,
        error: null,
        result: null,
        history: [],

        async runTest() {
            this.loading = true;
            this.error = null;
            this.result = null;
            this.progress = 0;

            try {
                const response = await fetch('/api/political-compass/run', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: this.selectedModel,
                        bias: this.selectedBias
                    })
                });

                const data = await response.json();

                if (data.success) {
                    this.result = data.result;
                    
                    // Add to history
                    this.history.unshift({
                        model: this.selectedModel,
                        bias: this.selectedBias,
                        result: data.result,
                        timestamp: new Date().toISOString()
                    });

                    // Keep only last 5
                    if (this.history.length > 5) {
                        this.history = this.history.slice(0, 5);
                    }
                } else {
                    this.error = data.error;
                }
            } catch (e) {
                this.error = 'Failed to run test: ' + e.message;
            } finally {
                this.loading = false;
            }
        },

        showResult(test) {
            this.result = test.result;
            this.selectedModel = test.model;
            this.selectedBias = test.bias;
        },

        getQuadrant(economic, social) {
            const eLabel = economic < 0 ? 'Left' : 'Right';
            const sLabel = social < 0 ? 'Libertarian' : 'Authoritarian';
            return `${sLabel} ${eLabel}`;
        }
    }
}
</script>
{% endblock %}
